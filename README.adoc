= FX Transactions PDF/CSV Utility
:toc:
:toc-title: Table of Contents
:toclevels: 3

== Overview

This utility provides a complete workflow for generating, extracting, and enriching FX transaction data. It supports:

* Generating synthetic FX transactions as PDFs
* Extracting those transactions to CSV
* Enriching transactions with market rates from a ClickHouse database
* Automated end-to-end execution via a shell script

== Directory Structure

[source]
----
.
├── create_fx_price_table.sql      # ClickHouse table schema and sample insert
├── fx_transactions_with_rates.py  # Enrich CSV with FX rates from ClickHouse
├── generate_fx_transactions_pdf.py# Generate random FX transactions PDF
├── get_fx_rates_from_clickhouse.py# Example: fetch rates as DataFrame
├── insert_fx_price_data.py        # Populate ClickHouse with synthetic FX prices
├── pdf_to_csv_fx_transactions.py  # Extract transactions from PDF to CSV
├── README.adoc                    # This documentation
├── README.md                      # Markdown version
├── requirements.txt               # Python dependencies
├── run_all.sh                     # End-to-end workflow script
├── setup.sh                       # Automated setup script
├── setup.py                       # Python package configuration
└── generated-pdf/                 # Output directory for PDFs
----

== Quickstart

. Run the setup script to install Python, dependencies, and prepare the environment:
+
[source,shell]
----
bash setup.sh
----

. Activate the environment and run the workflow:
+
[source,shell]
----
source .venv/bin/activate
./run_all.sh
----

== Python Environment Setup

[cols="1,3"]
|===
| Step | Command/Description

| Check Python Version
| `python3 --version` (Requires Python 3.8+)

| Create Virtual Environment
| `python3 -m venv .venv` +
  `source .venv/bin/activate` +
  (Windows: `.venv\Scripts\activate`)

| Upgrade pip
| `python -m pip install --upgrade pip`

| Install Dependencies
| `pip install -r requirements.txt`

| Deactivate Environment
| `deactivate`
|===

Troubleshooting tips:
* Ensure your virtual environment is activated before running scripts.
* Upgrade Python if you see version errors.
* Use `--user` with pip if you have permission issues.
* On ARM-based systems, install any required system libraries.

== Workflow Details

. Generate random FX transactions as PDF(s)
. Extract those transactions to a CSV file
. Enrich the CSV with market rates from ClickHouse
. (All steps can be run together with `run_all.sh`)

=== 1. Generate FX Transactions PDF


* Output: `generated-pdf/fx_transactions_*.pdf`

Control USD-only pairs via the `USD_ONLY` flag in the script.

=== 2. Extract Transactions from PDF to CSV


* Output: `fx_transactions.csv`
* Handles multiple PDFs and avoids duplicate headers.

=== 3. Enrich Transactions with FX Rates from ClickHouse


* Output: `fx_transactions_with_rates.csv`
* Adds columns: `bid_max`, `bid_min`, `ask_max`, `ask_min`
* Requires ClickHouse to be running and populated with price data for the relevant pairs and times.

=== 4. Run All Steps


This will:
* Remove previous PDFs and CSVs
* Generate new PDFs
* Extract CSV
* Enrich with rates

== ClickHouse Integration

=== Running ClickHouse

[source,shell]
----
docker run -d --name clickhouse-server \
  -e CLICKHOUSE_DB=default \
  -e CLICKHOUSE_USER=default \
  -e CLICKHOUSE_PASSWORD=MyNewSecretPass \
  -p 8123:8123 -p 9000:9000 clickhouse/clickhouse-server
----

* Web UI: http://localhost:8123/play

=== Creating the FX Price Table

Use the provided SQL file to create the table and insert a sample row:


=== Populating FX Price Data


* Populates all major USD pairs with 1-second intervals between 1:00 and 2:00 AM on 22nd July 2025.

== Packaging and Distribution

=== Bundling for Linux Environments

. Prepare your project directory with all scripts, requirements, and documentation.
. Use `setup.sh` to automate environment setup.
. Create a tarball or zip for distribution:
+
[source,shell]
----
tar czvf fx_txn_bundle.tar.gz /path/to/your/project
# or
zip -r fx_txn_bundle.zip /path/to/your/project
----

. On the target machine:
+
[source,shell]
----
tar xzvf fx_txn_bundle.tar.gz
cd fx_txn_bundle
bash setup.sh
source .venv/bin/activate
./run_all.sh
----

=== Creating a Python Package with setuptools

. Add a `setup.py` file:
+


. Refactor your scripts to provide a `main()` function for use as console scripts.
. Build and install locally:
+
[source,shell]
----
python setup.py sdist bdist_wheel
pip install dist/fx_transactions_tools-0.1.0-py3-none-any.whl
----

=== Bundling as a Standalone Executable with PyInstaller

. Install PyInstaller:
+
[source,shell]
----
pip install pyinstaller
----

. Bundle a script as an executable:
+
[source,shell]
----
pyinstaller --onefile run_all.sh
# or for a Python script:
pyinstaller --onefile fx_transactions_with_rates.py
----

. The executable will be in the `dist/` directory.

NOTE: For best results, use a minimal Python script as your entry point for PyInstaller.

== File Descriptions

* `generate_fx_transactions_pdf.py` - Generates random FX transactions in PDF format.
* `pdf_to_csv_fx_transactions.py` - Extracts transaction tables from PDFs to CSV.
* `fx_transactions_with_rates.py` - Enriches transactions with market rates from ClickHouse.
* `insert_fx_price_data.py` - Populates ClickHouse with synthetic FX price data.
* `get_fx_rates_from_clickhouse.py` - Example: fetches FX rates as a pandas DataFrame.
* `create_fx_price_table.sql` - Schema and sample insert for the `fx_price` table.
* `run_all.sh` - Cleans up and runs the full workflow.
* `setup.sh` - Automated environment setup.
* `setup.py` - Python package configuration.

== Troubleshooting

* Ensure ClickHouse is running and accessible.
* Make sure the time window for transactions overlaps with the price data in ClickHouse.
* If you see parsing errors for `tradedatetime`, check the date format in the PDF/CSV.
* All scripts assume the working directory is the project root.

== Notes

* All scripts are self-contained and require only Python and the listed dependencies.
* ClickHouse must be running and accessible from the target environment.
* Adjust the `clickhouse.properties` file as needed for your deployment.
