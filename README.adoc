= FX Transactions PDF/CSV Utility

:toc:
:toclevels: 3

== Overview

This utility provides a complete workflow for generating, extracting, and enriching FX transaction data. It supports:

* Generating synthetic FX transactions as PDFs
* Extracting those transactions to CSV
* Enriching transactions with market rates from a ClickHouse database
* Automated end-to-end execution via a shell script

== Directory Structure

[source]
----
.
├── create_fx_price_table.sql      # ClickHouse table schema and sample insert
├── fx_transactions_with_rates.py  # Enrich CSV with FX rates from ClickHouse
├── generate_fx_transactions_pdf.py# Generate random FX transactions PDF
├── get_fx_rates_from_clickhouse.py# Example: fetch rates as DataFrame
├── insert_fx_price_data.py        # Populate ClickHouse with synthetic FX prices
├── pdf_to_csv_fx_transactions.py  # Extract transactions from PDF to CSV
├── README.adoc                    # This documentation
├── README.md                      # Markdown version
├── requirements.txt               # Python dependencies
├── run_all.sh                     # End-to-end workflow script
└── generated-pdf/                 # Output directory for PDFs
----

== Python Setup

This project requires Python 3.8 or newer. It is strongly recommended to use a virtual environment to avoid dependency conflicts.

=== 1. Check Python Version

Ensure you have Python 3.8+:

[source,shell]
----
python3 --version
----

If you do not have Python 3 installed, download it from https://www.python.org/downloads/

=== 2. Create and Activate a Virtual Environment

[source,shell]
----
python3 -m venv .venv
source .venv/bin/activate
----

If you are on Windows, activate with:

[source,cmd]
----
.venv\Scripts\activate
----

=== 3. Upgrade pip (recommended)

[source,shell]
----
python -m pip install --upgrade pip
----

=== 4. Install Dependencies

All required Python packages are listed in `requirements.txt`:

[source,shell]
----
pip install -r requirements.txt
----

This will install:

* `fpdf` - for PDF generation
* `pdfplumber` - for extracting tables from PDFs
* `clickhouse-driver` - for connecting to ClickHouse
* `pandas` - for data manipulation

=== 5. Troubleshooting Python Setup

* If you see errors about missing packages, ensure your virtual environment is activated.
* If you see errors about incompatible Python versions, upgrade your Python installation.
* If you have permission errors, try adding `--user` to your pip install command or use a virtual environment.
* If you are using an M1/M2 Mac or other ARM-based system, some packages may require additional system dependencies.

=== 6. Deactivating the Virtual Environment

When you are done, you can deactivate the environment with:

[source,shell]
----
deactivate
----

== Workflow

The typical workflow is:

. Generate random FX transactions as PDF(s)
. Extract those transactions to a CSV file
. Enrich the CSV with market rates from ClickHouse
. (All steps can be run together with `run_all.sh`)

=== 1. Generate FX Transactions PDF

Generates one or more PDFs with random FX transactions.

[source,shell]
----
python generate_fx_transactions_pdf.py
----

* Output: `generated-pdf/fx_transactions_*.pdf`
* Each transaction includes:
** TradeDateTime (dd/mm/yy HH:MM:SS)
** Buy/Sell
** From CCY
** To CCY
** From Amt
** To Amt
** Exchange Rate
** Txn Number
** Account

You can control whether only USD pairs are generated by editing the `USD_ONLY` flag in the script.

=== 2. Extract Transactions from PDF to CSV

Extracts all tables from the generated PDFs and writes them to a single CSV.

[source,shell]
----
python pdf_to_csv_fx_transactions.py
----

* Output: `fx_transactions.csv`
* Handles multiple PDFs and avoids duplicate headers.

=== 3. Enrich Transactions with FX Rates from ClickHouse

For each transaction, looks up the relevant FX pair in ClickHouse and finds the max/min of the second-best bid/ask in the 30 seconds before the trade.

[source,shell]
----
python fx_transactions_with_rates.py
----

* Output: `fx_transactions_with_rates.csv`
* Adds columns: `bid_max`, `bid_min`, `ask_max`, `ask_min`
* Requires ClickHouse to be running and populated with price data for the relevant pairs and times.

=== 4. Run All Steps

To run the entire workflow and clean up previous outputs:

[source,shell]
----
bash run_all.sh
----

This will:
* Remove previous PDFs and CSVs
* Generate new PDFs
* Extract CSV
* Enrich with rates

== ClickHouse Integration

=== Running ClickHouse

You can run ClickHouse locally using Docker:

[source,shell]
----
docker run -d --name clickhouse-server \
  -e CLICKHOUSE_DB=default \
  -e CLICKHOUSE_USER=default \
  -e CLICKHOUSE_PASSWORD=MyNewSecretPass \
  -p 8123:8123 -p 9000:9000 clickhouse/clickhouse-server
----

* Web UI: http://localhost:8123/play

=== Creating the FX Price Table

Use the provided SQL file to create the table and insert a sample row:

[source,sql]
----
-- See create_fx_price_table.sql for full details
CREATE TABLE fx_price
(
    timestamp DateTime64(9),            -- Timestamp in nanoseconds (DateTime64 with 9 decimal places)
    date Date,                          -- Date (for partitioning/filtering)
    bids Array(Float64),                -- Array of bid prices
    asks Array(Float64),                -- Array of ask prices
    qtys Array(Float64),                -- Array of quantities
    ccypair String,                     -- Currency pair (e.g., "EURUSD")
    quoteId String,                     -- Quote identifier
    name String                         -- Name (e.g., source or venue)
)
ENGINE = MergeTree
PARTITION BY toYYYYMM(date)
ORDER BY (ccypair, timestamp);

-- Sample insert
INSERT INTO fx_price (
    timestamp, date, bids, asks, qtys, ccypair, quoteId, name
) VALUES
(
    '2024-06-01 12:00:00.123456789',
    '2024-06-01',
    [1.0850, 1.0848, 1.0845],
    [1.0852, 1.0854, 1.0856],
    [100000, 500000, 1000000],
    'EURUSD',
    'Q12345',
    'TestSource'
);
----

=== Populating FX Price Data

Populate the table with synthetic data for all major USD pairs, with 1-second intervals between 1:00 and 2:00 AM on 22nd July 2025:

[source,shell]
----
python insert_fx_price_data.py
----

* This script generates prices for all pairs in the relevant time window.

=== Querying FX Price Data

You can fetch FX rates as a pandas DataFrame:

[source,python]
----
from clickhouse_driver import Client
import pandas as pd

client = Client(host='localhost', port=9000, user='default', password='default', database='default')
query = """
SELECT
    timestamp,
    date,
    bids,
    asks,
    qtys,
    ccypair,
    quoteId,
    name
FROM fx_price
WHERE ccypair = 'EURUSD'
ORDER BY timestamp DESC
"""
result = client.execute(query)
columns = ['timestamp', 'date', 'bids', 'asks', 'qtys', 'ccypair', 'quoteId', 'name']
df = pd.DataFrame(result, columns=columns)
df.set_index('timestamp', inplace=True)
print(df)
----

== File Descriptions

* `generate_fx_transactions_pdf.py` - Generates random FX transactions in PDF format.
* `pdf_to_csv_fx_transactions.py` - Extracts transaction tables from PDFs to CSV.
* `fx_transactions_with_rates.py` - Enriches transactions with market rates from ClickHouse.
* `insert_fx_price_data.py` - Populates ClickHouse with synthetic FX price data.
* `get_fx_rates_from_clickhouse.py` - Example: fetches FX rates as a pandas DataFrame.
* `create_fx_price_table.sql` - Schema and sample insert for the `fx_price` table.
* `run_all.sh` - Cleans up and runs the full workflow.

== Troubleshooting

* Ensure ClickHouse is running and accessible.
* Make sure the time window for transactions overlaps with the price data in ClickHouse.
* If you see parsing errors for `tradedatetime`, check the date format in the PDF/CSV.
* All scripts assume the working directory is the project root.

